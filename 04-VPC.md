# VPC
* Think of a VPC as a logical/virtual data center in the cloud.
* Consists of IGWs (or Virtual Private Gateways), Route Tables, Network Access Control Lists, Subnets and Security Groups.
* 1 Subnet = 1 Availability Zone.
* Can have multiple Subnets in same Availability Zone.
* Security Groups are Stateful. Network Access Control Lists are Stateless.
* No Transitive Peering.
* When you create a VPC, a default Route Table, Network Access Control List (NACL) and a default Security Group will also be created.
* It won't create any Subnets or will it create a default internet gateway.
* US-East-1A in your AWS account can be a completely different availability zone to US-East-1A in another AWS account. The AZs are randomized.
* Amazon always reserve 5 IP addresses within your subnets.
* You can only have 1 Internet Gateway per VPC.
* Security Groups can't span VPCs.
* https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html

## What can we do with a VPC?
* Launch instances into a subnet of your choosing.
* Assign custom IP address ranges in each subnet.
* Configure route tables between subnets.
* Create internet gateway and attach it to our VPC.
* Much better security control over your AWS resources.
* Instance security groups.
* Subnet network access control lists (ACLS)

## Default VPC vs Custom VPC
* Default VPC is user friendly, allowing you to immediately deploy instances.
* All Subnets in default VPC have a route out to the internet.
* Each EC2 instance has both a public and private IP address.

## VPC Peering
* Allows you to connect one VPC with another via a direct network route using private IP addresses.
* Instances behave as if they were on the same private network.
* You can peer VPCs with other AWS accounts as well as with other VPCs in the same account.
* Peering is in a star configuration: ie 1 central VPC peers with 4 others. **No Transitive Peering** (You can't peer one VPC through another VPC).
* You can peer between regions.

## Nat Instances
* When creating a NAT instance, disable source/destination check on the instance.
* NAT instances must be in a public subnet.
* There must be a route out of the private subnet to the NAT instance in order for this to work.
* The amount of traffic that NAT instances can support depends on the instance size. If you are bottlenecking, increase the instance size.
* You can create high availability using Autoscaling Groups, multiple subnets in different AZs and a script to automate failover.
* Behind a Security Group.

## Nat Gateways
* Redundant inside the Availability Zone.
* Can survive failure of EC2 instances.
* Cannot span Availability Zones.
* Preferred by the enterprise.
* Starts at 5Gpbs and scales currently to 45Gps.
* No need to patch.
* Not associated with Security Groups.
* Automatically assigned a public ip address.
* Remember to update your route tables so that it has a route out to the internet.
* No need to disable Source/Destination Checks.
* If you have resources in multiple Availability Zones and they share one NAT gateway, in the event that the NAT gateway's Availability Zone is down, resources in the other Availability Zones lose internet access. To create an Availability Zone independent architecture, create a NAT gateway in each Availability Zone and configure your routing to ensure that resources use the NAT gateway in the same Availability Zone.

## Network ACLs
* Your VPC automatically comes with a default network ACL and by default, it allows all outbound and inbound traffic.
* You can create custom network ACLs. By default, each custom network ACL denies all inbound and outbound traffic until you add rules.
* Each subnet in your VPC must be associated with a network ACL. If you don't explicitly associate a subnet with a network ACL, the subnet is automatically associated with the default network ACL.
* Block IP Addresses using network ACLs not Security Groups.
* You can associate a network ACL with multiple subnets; however, a subnet can be associated with only one network ACL at a time. When you associate a network ACL with a subnet, the previous association is removed.
* Network ACLs contain a numbered list of rules that is evaluated in order, starting with the lowest numbered rule.
* Network ACLs have separate inbound and outbound rules and each rule can either allow or deny traffic.
* Network ACLs are stateless; responses to allowed inbound traffic are subject to the rules for outbound traffic (and vice versa).

# ELBs and VPCs
* You need a minimum of two public subnets to deploy an internet facing load balancer.

# VPC Flow Logs
* You cannot enable flow logs for VPCs that are peered with your VPC unless the peered VPC is in you account.
* You can tag flow logs.
* After you've created a flow log, you cannot change its configurations. For example, you cannot associate a different IAM role with the flow log.
* Not all IP traffic is monitored;
    - Traffic generated by instances when they contact the Amazon DNS server. If you use your own DNS server, then all traffic to that DNS server is logged.
    - Traffic generated by a Windows instance for Amazon Windows license activation.
    - Traffic to and from 169.254.169.254 for instance metadata.
    - DHCP traffic.
    - Traffic to the reserved IP address for the default VPC router.

# Bastion Host
* A NAT Gateway or NAT Instance is used to provide internet traffic to EC2 instances in a private subnet.
* A Bastion is used to securely administer EC2 instances (Using SSH or RDP). Bastions are called Jump Boxes in various countries.
* You cannot use a NAT Gateway as a Bastion host.

# Direct Connect
* Direct Connect directly connects your data center to AWS.
* Useful for high throughput workloads (ie lots of network traffic).
* Or if you need a stable and reliable secure connection.
* Steps to create a Direct Connect Connection:
    - Create a virtual interface in the Direct Connect console. This is a **PUBLIC Virtual Interface**.
    - Go to the VPC console and then to VPN connections. Create a Customer Gateway.
    - Create a Virtual Private Gateway.
    - Attach the Virtual Private Gateway to the desired VPC.
    - Select VPN Connections and create a new VPN Connection.
    - Select the Virtual Private Gateway and the Customer Gateway.
    - Once the VPN is available, set up the VPN on the customer gateway or firewall.

# Global Accelerator
* AWS Global Accelerator is a service in which you create accelerators to improve availability and performance of your applications for local and global users.
* You are assigned two static IP addresses (or alternatively you can bring your own).
* You can control traffic using traffic dials. This is done within the endpoint group.
* You can control weighting to individual end points using weights.

# VPC Endpoints
* A VPC Endpoint enables you to privately connect your VPC to supported AWS services and VPC endpoint services powered by PrivateLink without requiring an internet gateway, NAT device, VPN connection or AWS Direct Connect connection. Instances in your VPC do not require public IP addresses to communicate with resources in the service. Traffic between your VPC and the other service does not leave the Amazon network.
* Endpoints are virtual devices. They are horizontally scaled, redundant and highly available VPC components that allow communication between instances in your VPC and services without imposing availability risks or bandwidth constraints on your network traffic.
* There are two types of VPC endpoints:
    - Interface Endpoints
    - Gateway Endpoints (Supports Amazon S3 and DynamoDB)

# AWS PrivateLink
* if you see a question asking about peering VPCs to tens, hundreds or thousands of customer VPCs, think of AWS PrivateLink.
* Doesn't require VPC peering; no route tables, NAT, IGWs etc.
* Requires a Network Load Balancer on the service VPC and an ENI on the customer VPC.

# Transit Gateway
* Allows you to have transitive peering between thousands of VPCs and on-premise data centers.
* Works on a hub-and-spoke model.
* Works on a regional basis but you can have it across multiple regions.
* You can use it across multiple AWS accounts using RAM (Resource Access Manager).
* You can use route tables to limit how VPCs talk to one another.
* Works with Direct Connect as well as VPN connections.
* Supports **IP multicast** (not supported by any other AWS service).

# VPC CloudHub
* If you have multiple sites, each with its own VPN connection, you can use AWS VPN CloudHub to connect those sites together.
* Hub-and-spoke model.
* Low cost; easy to manage.
* It operates over the public internet but all traffic between the customer gateway and the AWS VPN CloudHub is encrypted.

# AWS Network Costs
* Use private IP address over public IP addresses to save on costs. This then utilizes the AWS backbone network.
* If you want to cut all network costs, group your EC2 instances in the same Availability Zone and use private IP addresses. This will be cost-free but make sure to keep in mind single point of failure issues.

# Quiz
1. In a default VPC, when you launch an EC2 instance and don't specify a subnet, the EC2 instances are assigned 2 IP addresses at launch. What are they?
    - In a default VPC, when you launch an EC2 instance and don't specify a subnet, it's automatically launched into a default subnet in your default VPC. The default subnet may MapPublicIPOnLaunch set to the value of true. So when it is launched, a public and private IP is available for the instance.
2. You have five VPCs in a 'hub and spoke' configuration, with VPC 'A' in the center and individually peered with VPCs 'B', 'C', 'D', and 'E', which make up the spokes. There are no other VPC connections. Which of the following VPCs can VPC 'B' communicate with directly?
    - As transitive peering is not allowed, VPC 'B' can communicate directly only with VPC 'A'.
3. Which of the following is a chief advantage of using VPC gateway endpoints to connect your VPC to services such as S3 and DynamoDB?
    - In contrast to a NAT gateway, traffic between your VPC and the other services does not leave the Amazon network when using VPC gateway endpoints. A gateway endpoint is a gateway that you specify as a target for a route in your route table for traffic destined to a supported AWS service (S3 and DynamoDB).
4. When I create a new security group, all outbound traffic is allowed by default.
    - By default, a security group includes an outbound rule that allows all outbound traffic. You can remove the rule and add outbound rules that allow specific outbound traffic only. If your security group has no outbound rules, no outbound traffic originating from your instance is allowed.
5. Which of the following is true?
    - Security groups are stateful and Network Access Control Lists are stateless. Stateful means if you send a request from your instance, the response traffic for that request is allowed to flow in regardless of inbound security group rules.
6. How many internet gateways can be attached to a custom VPC?
    - Since an internet gateway is a highly available VPC component, only one is attachable to a custom VPC.
7. To save administration headaches, a consultant advises that you leave all security groups in web-facing subnets open on port 22 to 0.0.0.0/0 CIDR. That way, you can connect wherever you are in the world. Is this a good security design?
    - 0.0.0.0/0 would allow ANYONE from ANYWHERE to connect to your instances. This is generally a bad plan. The phrase 'web-facing subnets' does not mean just web servers. It would include any instances in that subnet some of which you may not want strangers attacking. You would only allow 0.0.0.0/0 on port 80 or 443 to connect to your public-facing Web Servers, or preferably only to an ELB. Good security starts by limiting public access to only what the customer needs. Please see the AWS Security white paper for complete details.
8. How many Amazon VPCs are allowed per AWS account per AWS Region? (Before any support requests to increase the number).
    - You can have up to five Amazon VPCs per AWS account per AWS Region, but you can place a support request to increase the number.
9. True or False: A subnet can span multiple Availability Zones.
    - Each subnet must reside entirely within one Availability Zone and cannot span across zones.
10. Which of the following statements are NOT true of EC2 instances in a VPC?
    - AWS releases your instance's public IP address when it is stopped, hibernated, or terminated. Your stopped or hibernated instance receives a new public IP address when it is started.
11. Having just created a new VPC and launching an instance into its Public Subnet, you realize that you have forgotten to assign a Public IP to the instance during creation. What is the simplest way to make your instance reachable from the outside world?
    - Although creating a new NIC & associating an EIP also results in your instance being accessible from the internet, it leaves your instance with 2 NICs & 2 private IPs as well as the Public Address and is therefore not the simplest solution. By default, any user-created VPC subnet WILL NOT automatically assign Public IPv4 Addresses to instances – the only subnet that does this is the “Default” VPC subnets automatically created by AWS in your account.
12. What is the purpose of an egress-only internet gateway?
    - The purpose of an egress-only internet gateway is to allow IPv6 based traffic within a VPC to access the internet, whilst denying any internet based resources to connection back into the VPC.
13. Security groups act like a firewall at the instance level, whereas _________ are an additional layer of security that act at the subnet level. (Fill in the blank with the correct answer.)
    - NACLs act on the subnet level, while security groups act on the instance level.
14. By default, EC2 instances in new subnets in a custom VPC can communicate with each other across Availability Zones.
    - In a custom VPC with new subnets in each AZ, there is a route within the route table that supports communication across all subnets/AZs. Additionally, it has a Default SG with an "allow" rule: all traffic, all protocols, all ports, from resource using this default security group.
15. What is the advantage of running your AWS VPN connection through your Direct Connect connection over using the ordinary Internet?
    - It is likely that if you choose to run your VPN through a Direct Connect from your datacenter to the AWS network that your VPN connection will be both faster, and more secure. However data charges are still incurred whilst using Direct Connect. Additionally Transit Gateway attachments may be made to VPN regardless of if it is through DX or not.
16. What is the name of the AWS Global Accelerator component that services the static IP addresses for your accelerator from a unique IP subnet?
    - A network zone services the static IP addresses for your accelerator from a unique IP subnet. Similar to an AWS Availability Zone, a network zone is an isolated unit with its own set of physical infrastructure. When you configure an accelerator, by default, Global Accelerator allocates two IPv4 addresses for it. If one IP address from a network zone becomes unavailable due to IP address blocking by certain client networks, or network disruptions, then client applications can retry on the healthy static IP address from the other isolated network zone.
    
        Reference: AWS Global Accelerator components
17. True or False: You can accelerate your application by adding a second Internet Gateway to your VPC.
    - You can only have one Internet Gateway per VPC.
18. True or False: An Application Load Balancer must be deployed into at least two Availability Zone subnets.
    - An Application Load Balancer must be deployed into at least two Availability Zone subnets.
19. Which of the following offers the largest range of internal IP addresses?
    - The /16 offers 65,536 possible addresses.
20. When peering VPCs, you may peer your VPC only with another VPC in your same AWS account.
    - You may peer a VPC to another VPC that's in your same account, or to any VPC in any other account.
21. Which of the following options allows you to securely administer an EC2 instance located in a private subnet?
    - A Bastion host allows you to securely administer (via SSH or RDP) an EC2 instance located in a private subnet. Don't confuse Bastions and NATs, which allow outside traffic to reach an instance in a private subnet.
22. A VPN connection consists of which of the following components?
    - A Virtual Private Gateway sits at the edge of your VPC and is a key component when using a VPN. It's responsible for site-to-site connection from on-premises to a VPC.

        A customer gateway is a resource that is installed on the customer side and provides a customer gateway inside a VPC.
23. When you create a custom VPC, which of the following are created automatically?
    - When you create a custom VPC, a default Security Group, network access control list (ACL), and route table are created automatically. You must create your own subnets, internet gateway, and NAT gateway (if you need one).
24. Which of the following are true for security groups?
    - Security groups operate at the instance level (as they are associated with network interfaces), they support "allow" rules only, and they evaluate all rules before deciding whether to allow traffic.

        Security groups control access at the instance-level (as they are associated with network interfaces), they support "allow" rules only, and they evaluate all rules before deciding whether to allow traffic into the instance(s).
25. VPC stands for:
    - VPC stand for Virtual Private Cloud. It is a logically isolated (private) section where you can place AWS resources within a virtual network.
26. At which of the following levels can VPC Flow Logs be created?
    - VPC Flow Logs can be created at the VPC, subnet, and network interface levels. VPC Flow Logs is a feature that enables you to capture information about the IP traffic going to and from network interfaces in your VPC.
27. Are you permitted to conduct your own security assessments or penetration tests on your own VPC without alerting AWS first?
    - AWS customers are welcome to carry out security assessments or penetration tests against their AWS infrastructure without prior approval for 8 services only. You should request authorization for other simulated events. Reference: Penetration Testing.
28. Which of these is NOT a component of the AWS Global Accelerator service?
    - AWS Global Accelerator and Amazon CloudFront are separate services that use the AWS global network and its edge locations around the world. CloudFront improves performance for both cacheable content (such as images and videos) and dynamic content (such as API acceleration and dynamic site delivery). Global Accelerator improves performance for a wide range of applications over TCP or UDP by proxying packets at the edge to applications running in one or more AWS Regions.


